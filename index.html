
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>API Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
    <link href="images/favicon.ico" rel="icon" type="image/ico" />
  </head>

  <body class="index" data-languages="[&quot;shell&quot;,&quot;go&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">shell</a>
              <a href="#" data-language-name="go">go</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#topics" class="toc-h1 toc-link" data-title="Topics">Topics</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#creating-a-topic" class="toc-h2 toc-link" data-title="Creating a topic">Creating a topic</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#producing-a-message" class="toc-h1 toc-link" data-title="Producing a message">Producing a message</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#now" class="toc-h2 toc-link" data-title="Now">Now</a>
                  </li>
                  <li>
                    <a href="#in-the-future" class="toc-h2 toc-link" data-title="In the future">In the future</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#consuming" class="toc-h1 toc-link" data-title="Consuming">Consuming</a>
          </li>
      </div>
        <ul class="toc-footer">
            <li><a href='https://github.com/lord/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Welcome to the Sandglass API documentation.</p>
<h1 id='topics'>Topics</h1><h2 id='creating-a-topic'>Creating a topic</h2>
<blockquote>
<p>To create a topic:</p>
</blockquote>
<pre class="highlight shell tab-shell"><code>sandctl topics create emails --num_partitions 6 --replication_factor 3
</code></pre><pre class="highlight go tab-go"><code><span class="n">client</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sg</span><span class="o">.</span><span class="n">NewClient</span><span class="p">(</span><span class="x">
    </span><span class="n">sg</span><span class="o">.</span><span class="n">WithAddresses</span><span class="p">(</span><span class="s">":7170"</span><span class="p">),</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">CreateTopic</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span><span class="x"> </span><span class="o">&amp;</span><span class="n">sgproto</span><span class="o">.</span><span class="n">CreateTopicParams</span><span class="p">{</span><span class="x">
  </span><span class="n">Name</span><span class="o">:</span><span class="x"> </span><span class="s">"emails"</span><span class="p">,</span><span class="x">
  </span><span class="n">NumPartitions</span><span class="o">:</span><span class="x"> </span><span class="m">6</span><span class="p">,</span><span class="x">
  </span><span class="n">ReplicationFactor</span><span class="o">:</span><span class="x"> </span><span class="m">3</span><span class="p">,</span><span class="x">
</span><span class="p">})</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<blockquote>
<p>Make sure to replace <code>:7170</code> with the address of at least one node in the cluster</p>
</blockquote>

<p>A topic has a name, a number of partitions and a replication factor.
Here is a table describing the required/optional params:</p>

<table><thead>
<tr>
<th>Parameter</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td>name</td>
<td>true</td>
<td>The name of the topic, must not start with an underscore <code>_</code> and only be composed of alphanumeric characters</td>
</tr>
<tr>
<td>num partitions</td>
<td>true</td>
<td>The number of partitions</td>
</tr>
<tr>
<td>replication factor</td>
<td>true</td>
<td>The number of nodes to replicate each partition to</td>
</tr>
<tr>
<td>kind</td>
<td>false</td>
<td>The topic kind. Default: <strong>Timer</strong></td>
</tr>
<tr>
<td>storage driver</td>
<td>false</td>
<td>The storage engine to use (RocksDB or Badger). Default: <strong>RocksDB</strong></td>
</tr>
</tbody></table>
<h1 id='producing-a-message'>Producing a message</h1><h2 id='now'>Now</h2><pre class="highlight shell tab-shell"><code>sandctl produce emails <span class="s1">'{"dest" : "hi@example.com"}'</span>
</code></pre><pre class="highlight go tab-go"><code><span class="n">client</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sg</span><span class="o">.</span><span class="n">NewClient</span><span class="p">(</span><span class="x">
    </span><span class="n">sg</span><span class="o">.</span><span class="n">WithAddresses</span><span class="p">(</span><span class="s">":7170"</span><span class="p">),</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">Produce</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span><span class="x"> </span><span class="s">"emails"</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="o">&amp;</span><span class="n">sgproto</span><span class="o">.</span><span class="n">Message</span><span class="p">{</span><span class="x">
    </span><span class="n">Value</span><span class="o">:</span><span class="x"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">`{"dest" : "hi@example.com"}`</span><span class="p">),</span><span class="x">
</span><span class="p">})</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p>When producing a new message to a topic we need to specify to which partition the message should be produced in.</p>

<p>However, an empty partition means choose a random one. This is for convenience and when there is not need to partition in a particular partition.</p>
<h2 id='in-the-future'>In the future</h2><pre class="highlight go tab-go"><code><span class="n">client</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sg</span><span class="o">.</span><span class="n">NewClient</span><span class="p">(</span><span class="x">
    </span><span class="n">sg</span><span class="o">.</span><span class="n">WithAddresses</span><span class="p">(</span><span class="s">":7170"</span><span class="p">),</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// Now we produce a new message that will be consumed in one hour</span><span class="x">
</span><span class="n">inOneHour</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="x"> </span><span class="o">*</span><span class="x"> </span><span class="n">time</span><span class="o">.</span><span class="n">Hour</span><span class="p">)</span><span class="x">
</span><span class="n">gen</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sandflake</span><span class="o">.</span><span class="n">NewFixedTimeGenerator</span><span class="p">(</span><span class="n">inOneHour</span><span class="p">)</span><span class="x">

</span><span class="n">msg</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">sgproto</span><span class="o">.</span><span class="n">Message</span><span class="p">{</span><span class="x">
    </span><span class="n">Offset</span><span class="o">:</span><span class="x"> </span><span class="n">gen</span><span class="o">.</span><span class="n">Next</span><span class="p">(),</span><span class="x">
    </span><span class="n">Value</span><span class="o">:</span><span class="x">  </span><span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"Hello"</span><span class="p">),</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">ProduceMessage</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span><span class="x"> </span><span class="s">"emails"</span><span class="p">,</span><span class="x"> </span><span class="s">""</span><span class="p">,</span><span class="x"> </span><span class="n">msg</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p>The way to produce a message in future, is by setting a custom <a href="https://github.com/celrenheit/sandflake">sandflake id</a> with the time that you want.</p>
<h1 id='consuming'>Consuming</h1><pre class="highlight shell tab-shell"><code>sandctl consume emails
</code></pre><pre class="highlight go tab-go"><code><span class="n">client</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sg</span><span class="o">.</span><span class="n">NewClient</span><span class="p">(</span><span class="x">
    </span><span class="n">sg</span><span class="o">.</span><span class="n">WithAddresses</span><span class="p">(</span><span class="s">":7170"</span><span class="p">),</span><span class="x">
</span><span class="p">)</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span><span class="k">defer</span><span class="x"> </span><span class="n">client</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">

</span><span class="n">mux</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">sg</span><span class="o">.</span><span class="n">NewMux</span><span class="p">()</span><span class="x">
</span><span class="n">mux</span><span class="o">.</span><span class="n">SubscribeFunc</span><span class="p">(</span><span class="s">"emails"</span><span class="p">,</span><span class="x"> </span><span class="k">func</span><span class="p">(</span><span class="n">msg</span><span class="x"> </span><span class="o">*</span><span class="n">sgproto</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="c">// handle message</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"received: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="kt">string</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">Value</span><span class="p">))</span><span class="x">
    </span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">})</span><span class="x">

</span><span class="n">m</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">sg</span><span class="o">.</span><span class="n">MuxManager</span><span class="p">{</span><span class="x">
    </span><span class="n">Client</span><span class="o">:</span><span class="x">               </span><span class="n">c</span><span class="p">,</span><span class="x">
    </span><span class="n">Mux</span><span class="o">:</span><span class="x">                  </span><span class="n">mux</span><span class="p">,</span><span class="x">
    </span><span class="n">ReFetchSleepDuration</span><span class="o">:</span><span class="x"> </span><span class="n">dur</span><span class="p">,</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">m</span><span class="o">.</span><span class="n">Start</span><span class="p">()</span><span class="x">
</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
    </span><span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre>
<p>In Go, when using Handlers and Subscribe(Func) methods, each message received will launch a new goroutine.</p>

<aside class="notice">
If the handler returns non-nil error the message will be <code>NACKed</code> and made available for redelivery. Otherwise, the message will be <code>ACK</code>.
</aside>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">shell</a>
                <a href="#" data-language-name="go">go</a>
          </div>
      </div>
    </div>
  </body>
</html>
